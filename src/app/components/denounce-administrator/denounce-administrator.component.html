<main class="admin-layout">
    <!-- Header del administrador -->
    <div class="admin-header">
        <div class="admin-title">
            <div class="title-text">
                <h2>Panel de Administración</h2>
                <p>Gestión y seguimiento de denuncias ambientales</p>
            </div>
        </div>
        <div class="logout" (click)="logout()">
            <i class="bi bi-arrow-bar-left"></i>
            <span>Cerrar Sesión</span>
        </div>
    </div>

    <!-- Contenido principal -->
    <section>
        <!-- Navegación de filtros -->
        <nav (change)="processFilter()">
            <div class="item">
                <div class="filter-container">
                    <h3>Documento Denunciante</h3>
                    <input 
                        type="text" 
                        id="denouncer-filter" 
                        name="denouncer-filter" 
                        [(ngModel)]="filterInformation.denouncerDocNumber" 
                        pattern="^\d{8}$|^\d{11}$"
                        placeholder="Ingrese documento">
                </div>
                <div class="filter-container">
                    <h3>Documento Denunciado</h3>
                    <input 
                        type="text" 
                        id="denounced-filter" 
                        name="denounced-filter" 
                        [(ngModel)]="filterInformation.denouncedDocNumber" 
                        pattern="^\d{8}$|^\d{11}$"
                        placeholder="Ingrese documento">
                </div>
            </div>
            <div class="item">
                <div class="filter-container">
                    <h3>Filtrar por Fecha</h3>
                    <input 
                        type="date" 
                        id="date" 
                        name="date" 
                        [(ngModel)]="filterInformation.date">
                </div>
                <div class="filter-container">
                    <h3>Estado de Denuncia</h3>
                    <select name="state-filter" id="state-filter" [(ngModel)]="filterInformation.denounceType">
                        <option value="null" selected>Todos los estados</option>
                        <option value="Registrado">Registrado</option>
                        <option value="Recibido">Recibido</option>
                        <option value="Atendido">Atendido</option>
                    </select>
                </div>
            </div>
        </nav>

        <!-- Contenedor de tabla -->
        <div class="table-container">
            @if (denounces.length === 0) {
                <div class="nocontent">
                    <i class="bi bi-file-earmark-x"></i>
                    <h3>No hay registros disponibles</h3>
                    <p>No se encontraron denuncias que coincidan con los criterios de búsqueda</p>
                </div>
            } @else {
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Denunciante</th>
                            <th>Denunciado</th>
                            <th>Motivo</th>
                            <th>Anónimo</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (denounce of denounces; track denounce.idDenounce) {
                            <tr>
                                <td>{{ denounce.idDenounce }}</td>
                                <td>
                                    <div class="person-flag {{ processIsNatural(denounce.denouncerDocNumber) ? 'natural' : 'juridic' }}">
                                        <span>{{ processIsNatural(denounce.denouncerDocNumber) ? 'Natural' : 'Jurídica' }}</span>
                                        <strong>{{ denounce.denouncerDocNumber }}</strong>
                                    </div>
                                    <span>{{ denounce.denouncer }}</span>
                                </td>
                                <td>
                                    <div class="person-flag {{ processIsNatural(denounce.denouncedDocNumber) ? 'natural' : 'juridic' }}">
                                        <span>{{ processIsNatural(denounce.denouncedDocNumber) ? 'Natural' : 'Jurídica' }}</span>
                                        <strong>{{ denounce.denouncedDocNumber }}</strong>
                                    </div>
                                    <span>{{ denounce.denounced }}</span>
                                </td>
                                <td>
                                    <div>
                                        <p>{{ denounce.reason }}</p>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge {{ denounce.anonymous === 1 ? 'anonymous-yes' : 'anonymous-no' }}">
                                        {{ denounce.anonymous === 1 ? 'SÍ' : 'NO' }}
                                    </span>
                                </td>
                                <td>{{ denounce.date }}</td>
                                <td>
                                    <div class="state-checkbox">
                                        @let availableStates = getAvailableStates(denounce.state);
                                        @let denounceIndex = $index;

                                        @for (state of availableStates; track $index) {
                                            @if ($index === 0) {
                                                <div class="state {{ setStateStyle(state) }}" (click)="processFocusOnChangeState($event)">
                                                    {{ state.toLowerCase() }}
                                                </div>
                                            } @else {
                                                <div class="state {{ setStateStyle(state) }}" 
                                                     [ngStyle]="{ '--translate': $index * 34 + 'px' }" 
                                                     (click)="prepareUpdateDenounceModal(state, denounce.state, denounce.idDenounce, denounceIndex)">
                                                    {{ state.toLowerCase() }}
                                                </div>
                                            }
                                        }
                                    </div>
                                </td>
                                <td>
                                    <div class="action-container">
                                        <div class="action-btn details-btn" 
                                             (click)="showDenounceDetails(denounce.idDenounce)"
                                             title="Ver detalles">
                                            <i class="bi bi-info-circle"></i>
                                        </div>
                                        <div class="action-btn pdf-btn" 
                                             (click)="requestPDF(denounce.idDenounce)"
                                             title="Descargar PDF">
                                            <i class="bi bi-file-pdf-fill"></i>
                                        </div>
                                        <div class="action-btn state-historial-btn" 
                                             (click)="trackingModal.prepareTrackingModal(denounce.idDenounce, denounceIndex)"
                                             title="Ver historial">
                                            <i class="bi bi-card-checklist"></i>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

        <!-- Paginación -->
        <div class="pagination">
            <div class="page-number-container">
                @let totalPagination = getTotalPagination();

                <i class="bi bi-arrow-left-short" 
                   [ngClass]="{ 'invalid': actualOffset <= 1 || totalPagination === 0 }" 
                   (click)="processArrowPaginationBackward()"
                   title="Página anterior"></i>
                   
                <span>Página</span>
                <input type="number" 
                       id="pagination-input" 
                       name="pagination-input" 
                       [(ngModel)]="actualOffset" 
                       min="1" 
                       max="{{ getTotalPagination() }}" 
                       (change)="processPaginationInput()">
               
                <span>de {{ getTotalPagination() }}</span>
                
                <i class="bi bi-arrow-right-short" 
                   [ngClass]="{ 'invalid': actualOffset >= totalPagination || totalPagination === 0 }" 
                   (click)="processArrowPaginationForward()"
                   title="Página siguiente"></i>
            </div>
        </div>
    </section>
</main>

<!-- Modal de información detallada -->
<div class="modal more-information-modal" [ngClass]="{'closed': !showMoreInformationModal}">
    <div class="popup">
        <div class="head">
            <h3>Información Detallada de la Denuncia</h3>
        </div>
        <div class="container">
            <div class="content" [ngClass]="{'viewed': actualModalView !== 0, 'on-view': actualModalView === 0 }">
                <div class="row">
                    <h4>Código de Denuncia</h4>
                    <span>{{ denounceDetails.code }}</span>
                </div>
                <div class="row">
                    <h4>Fecha de Registro</h4>
                    <span>{{ denounceDetails.date }}</span>
                </div>
                <div class="row">
                    <h4>Dirección del Hecho</h4>
                    <span>{{ denounceDetails.address }}</span>
                </div>
                <div class="row">
                    <h4>Referencia</h4>
                    <span>{{ denounceDetails.reference }}</span>
                </div>
                <div class="row facts-description">
                    <h4>Descripción del Hecho</h4>
                    <span>{{ denounceDetails.factsDescription }}</span>
                </div>
            </div>
            <div class="content" [ngClass]="{'viewed': actualModalView === 2, 'on-view': actualModalView === 1, 'unviewed': actualModalView !== 1 }">
                <div class="row">
                    <h4>Entidad Dirigida</h4>
                    <span>{{ denounceDetails.hasPreviousDenounce === 1 ? denounceDetails.directedEntity : 'NO REALIZÓ NINGUNA DENUNCIA PREVIA' }}</span>
                </div>
                <div class="row">
                    <h4>Respuesta de Entidad</h4>
                    <span>{{ denounceDetails.hasResponse === 1 ? denounceDetails.entityResponse : 'SIN RESPUESTA' }}</span>
                </div>
                <div class="row">
                    <h4>Mantener Identidad Privada</h4>
                    <span>{{ denounceDetails.keepIdentity === 1 ? 'SÍ' : 'NO' }}</span>
                </div>
                <div class="row comunication-media">
                    <h4>Medio de Comunicación</h4>
                    <span>{{ denounceDetails.comunicationMedia }}</span>
                </div>
                <div class="row source">
                    <h4>Fuente</h4>
                    <span>{{ denounceDetails.source }}</span>
                </div>
            </div>
            <div class="content" [ngClass]="{'on-view': actualModalView === 2, 'unviewed': actualModalView !== 2 }">
                <div class="row ambiental-promise">
                    <h4>Compromiso Ambiental</h4>
                    <span>{{ denounceDetails.ambientalPromise }}</span>
                </div>
                <div class="row">
                    <h4>Causas Ambientales</h4>
                    <div class="ambiental-container">
                        <ul>
                            @let ambientalCause = denounceDetails.ambientalCauses.split(',');
                            @for (cause of ambientalCause; track $index) {
                                <li>{{ cause }}</li>
                            }
                        </ul>
                    </div>
                </div>
                <div class="row">
                    <h4>Pruebas Adjuntadas</h4>
                    <div class="proof-container">
                        @if (denounceDetails.proofs) {
                            @let proofs = denounceDetails.proofs.split(',');
                            <ul>
                                @for (proof of proofs; track $index) {
                                    @let proofName = proof.split('/')[2];
                                    @let extension = proofName.split('.')[1];
                                    <li (click)="requestProof(proof)">
                                        @switch (extension) {
                                            @case ('pdf') {
                                                <i class="bi bi-file-pdf"></i>
                                            }
                                            @case ('mp4') {
                                                <i class="bi bi-camera-video"></i>
                                            }
                                            @default {
                                                <i class="bi bi-image"></i>
                                            }
                                        }
                                        <p>{{ proofName }}</p>
                                    </li>
                                }
                            </ul>
                        } @else {
                            <p>No hay pruebas disponibles</p>
                        }
                    </div>
                </div>
                <div class="row proof-description">
                    <h4>Descripción de las Pruebas</h4>
                    <span>{{ denounceDetails.proofDescription.length === 0 ? 'NO ESPECIFICA' : denounceDetails.proofDescription }}</span>
                </div>
            </div>
        </div>
        <div class="footer">
            <button (click)="closeDenounceDetailsModal()" class="close-modal-btn">Cerrar</button>
            <div>
                <button class="prev" [class.disabled-btn]="actualModalView === 0" (click)="backModalView()">Anterior</button>
                <button class="next" [class.disabled-btn]="actualModalView === 2" (click)="nextModalView()">Siguiente</button>
            </div>
        </div>
    </div>
</div> 

<!-- Modal de actualización de estado -->
<div class="modal update-denounce-modal" [ngClass]="{'closed': !showUpdateDenounceModal}">
    <div class="popup">
        <div class="head">
            <h3>Actualizar Estado de la Denuncia</h3>
        </div>
        <div class="content">
            <h4>Estado Actual <span class="old-state">{{ updateDenounceModalInformation.oldState }}</span></h4>
            <h4>Nuevo Estado <span class="new-state">{{ updateDenounceModalInformation.newState }}</span></h4>
            <h4>Descripción de Acciones Realizadas</h4>
            <textarea 
                name="description-update-modal" 
                id="description-update-modal" 
                [(ngModel)]="updateDenounceModalInformation.description"
                placeholder="Describa las acciones realizadas o los motivos del cambio de estado..."></textarea>
        </div>
        <div class="footer">
            <button class="close-modal-btn" (click)="toggleShowUpdateDenounceModal()">Cancelar</button>
            <button class="update-btn" (click)="changeState()">Actualizar Estado</button>
        </div>
    </div>
</div> 

<app-denounce-tracking-modal [consultant]="consultant" (stateUpdate)="processDenounceStateUpdate($event)"></app-denounce-tracking-modal>
