
<main class="admin-layout">
    <!-- Header del administrador -->
    <div class="admin-header">
        <div class="admin-title">
            <div class="title-text">
                <h2>Panel de Administración</h2>
                <p>Gestión y seguimiento de denuncias ambientales</p>
            </div>
        </div>
        <div class="logout" (click)="logout()">
            <i class="bi bi-arrow-bar-left"></i>
            <span>Cerrar Sesión</span>
        </div>
    </div>

    <!-- Contenido principal -->
    <section>
        <!-- Navegación de filtros -->
        <nav (change)="processFilter()">
            <div class="item">
                <div class="filter-container">
                    <h3>Documento Denunciante</h3>
                    <input 
                        type="text" 
                        id="denouncer-filter" 
                        name="denouncer-filter" 
                        [(ngModel)]="filterInformation.denouncerDocNumber" 
                        pattern="^\d{8}$|^\d{11}$"
                        placeholder="Ingrese documento">
                </div>
                <div class="filter-container">
                    <h3>Documento Denunciado</h3>
                    <input 
                        type="text" 
                        id="denounced-filter" 
                        name="denounced-filter" 
                        [(ngModel)]="filterInformation.denouncedDocNumber" 
                        pattern="^\d{8}$|^\d{11}$"
                        placeholder="Ingrese documento">
                </div>
            </div>
            <div class="item">
                <div class="filter-container">
                    <h3>Filtrar por Fecha</h3>
                    <input 
                        type="date" 
                        id="date" 
                        name="date" 
                        [(ngModel)]="filterInformation.date">
                </div>
                <div class="filter-container">
                    <h3>Estado de Denuncia</h3>
                    <select name="state-filter" id="state-filter" [(ngModel)]="filterInformation.denounceType">
                        <option value="null" selected>Todos los estados</option>
                        <option value="Registrado">Registrado</option>
                        <option value="Recibido">Recibido</option>
                        <option value="Atendido">Atendido</option>
                    </select>
                </div>
            </div>
        </nav>

        <!-- Contenedor de tabla -->
        <div class="table-container">
            @if (denounces.length === 0) {
                <div class="nocontent">
                    <i class="bi bi-file-earmark-x"></i>
                    <h3>No hay registros disponibles</h3>
                    <p>No se encontraron denuncias que coincidan con los criterios de búsqueda</p>
                </div>
            } @else {
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>DENUNCIANTE</th>
                            <th>DENUNCIADO</th>
                            <th>MOTIVO</th>
                            <th>ANÓNIMO</th>
                            <th>FECHA</th>
                            <th>ESTADO</th>
                            <th>ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (item of denounces; track item.idDenounce; let rowIndex = $index) {
                            <tr>
                                <td>{{ item.idDenounce }}</td>
                                <td>
                                    <div class="person-flag" [ngClass]="processIsNatural(item.denouncerDocNumber) ? 'natural' : 'juridic'">
                                        {{ processIsNatural(item.denouncerDocNumber) ? 'NATURAL' : 'JURÍDICA' }}
                                    </div>
                                    <span>{{ item.denouncerDocNumber }}</span>
                                    <span>{{ item.denouncer }}</span>
                                </td>
                                <td>
                                    <div class="person-flag" [ngClass]="processIsNatural(item.denouncedDocNumber) ? 'natural' : 'juridic'">
                                        {{ processIsNatural(item.denouncedDocNumber) ? 'NATURAL' : 'JURÍDICA' }}
                                    </div>
                                    <span>{{ item.denouncedDocNumber }}</span>
                                    <span>{{ item.denounced }}</span>
                                </td>
                                <td>{{ item.reason }}</td>
                                <td>
                                    <span class="badge" [ngClass]="item.anonymous === 1 ? 'anonymous-yes' : 'anonymous-no'">
                                        {{ item.anonymous === 1 ? 'SÍ' : 'NO' }}
                                    </span>
                                </td>
                                <td>{{ item.date }}</td>
                                <td>
                                    <div class="state-checkbox">
                                        @for (availableState of getAvailableStates(item.state); track availableState; let stateIndex = $index) {
                                            <div class="state" [ngClass]="setStateStyle(availableState)"
                                                (click)="prepareUpdateDenounceModal(availableState, item.state, item.idDenounce, rowIndex)">
                                                {{ availableState }}
                                            </div>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <div class="action-container">
                                        <button class="action-btn details-btn" (click)="showDenounceDetails(item.idDenounce)">
                                            <i class="bi bi-info-circle"></i>
                                        </button>
                                        <button class="action-btn pdf-btn" (click)="requestPDF(item.idDenounce)">
                                            <i class="bi bi-file-earmark-pdf"></i>
                                        </button>
                                        <button class="action-btn state-historial-btn" (click)="trackingModal.openModal(item.idDenounce)">
                                            <i class="bi bi-clock-history"></i>
                                        </button>
                                        <button class="action-btn denounced-btn" 
                                                (click)="openUpdateDenouncedModal(item.idDenounce)"
                                                [disabled]="!isDenounceWithoutDenouncedData(item)">
                                            <i class="bi bi-person-fill"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

        <!-- Paginación -->
        <div class="pagination">
            <div class="page-number-container">
                @let totalPagination = getTotalPagination();

                <i class="bi bi-arrow-left-short" 
                   [ngClass]="{ 'invalid': actualOffset <= 1 || totalPagination === 0 }" 
                   (click)="processArrowPaginationBackward()"
                   title="Página anterior"></i>
                   
                <span>Página</span>
                <input type="number" 
                       id="pagination-input" 
                       name="pagination-input" 
                       [(ngModel)]="actualOffset" 
                       min="1" 
                       max="{{ getTotalPagination() }}" 
                       (change)="processPaginationInput()">
               
                <span>de {{ getTotalPagination() }}</span>
                
                <i class="bi bi-arrow-right-short" 
                   [ngClass]="{ 'invalid': actualOffset >= totalPagination || totalPagination === 0 }" 
                   (click)="processArrowPaginationForward()"
                   title="Página siguiente"></i>
            </div>
        </div>
    </section>
</main>

<!-- Modal de información detallada -->
<div class="modal more-information-modal" [ngClass]="{'closed': !showMoreInformationModal}">
    <div class="popup">
        <div class="head">
            <h3>Información Detallada de la Denuncia</h3>
        </div>
        <div class="container">
            <!-- Primera sección: Información básica -->
            <div class="content" [ngClass]="{'viewed': actualModalView !== 0, 'on-view': actualModalView === 0 }">
                <div class="info-grid two-columns">
                    <div class="info-section">
                        <h4>Código de Denuncia</h4>
                        <p class="value">{{ denounceDetails.code }}</p>
                    </div>
                    <div class="info-section">
                        <h4>Fecha de Registro</h4>
                        <p class="value">{{ denounceDetails.date }}</p>
                    </div>
                    <div class="info-section">
                        <h4>Dirección del Hecho</h4>
                        <p class="value">{{ denounceDetails.address }}</p>
                    </div>
                    <div class="info-section">
                        <h4>Referencia</h4>
                        <p class="value">{{ denounceDetails.reference }}</p>
                    </div>
                </div>
                <div class="info-section">
                    <h4>Descripción del Hecho</h4>
                    <p class="value highlight">{{ denounceDetails.factsDescription }}</p>
                </div>
            </div>

            <!-- Segunda sección: Información adicional -->
            <div class="content" [ngClass]="{'viewed': actualModalView === 2, 'on-view': actualModalView === 1, 'unviewed': actualModalView !== 1 }">
                <div class="info-grid">
                    <div class="info-section">
                        <h4>Entidad Dirigida</h4>
                        <p class="value">{{ denounceDetails.hasPreviousDenounce === 1 ? denounceDetails.directedEntity : 'No realizó ninguna denuncia previa' }}</p>
                    </div>
                    <div class="info-section">
                        <h4>Respuesta de Entidad</h4>
                        <p class="value">{{ denounceDetails.hasResponse === 1 ? denounceDetails.entityResponse : 'Sin respuesta' }}</p>
                    </div>
                    <div class="info-section">
                        <h4>Mantener Identidad Privada</h4>
                        <span class="status-badge {{ denounceDetails.keepIdentity === 1 ? 'yes' : 'no' }}">
                            {{ denounceDetails.keepIdentity === 1 ? 'Sí' : 'No' }}
                        </span>
                    </div>
                    <div class="info-section">
                        <h4>Medio de Comunicación</h4>
                        <p class="value">{{ denounceDetails.comunicationMedia }}</p>
                    </div>
                    <div class="info-section">
                        <h4>Fuente</h4>
                        <p class="value">{{ denounceDetails.source }}</p>
                    </div>
                </div>
            </div>

            <!-- Tercera sección: Información ambiental y pruebas -->
            <div class="content" [ngClass]="{'on-view': actualModalView === 2, 'unviewed': actualModalView !== 2 }">
                <div class="info-grid">
                    <div class="info-section">
                        <h4>Compromiso Ambiental</h4>
                        <p class="value highlight">{{ denounceDetails.ambientalPromise }}</p>
                    </div>
                    <div class="info-section">
                        <h4>Causas Ambientales</h4>
                        @let ambientalCause = denounceDetails.ambientalCauses.split(',');
                        <ul class="ambiental-list">
                            @for (cause of ambientalCause; track cause) {
                                <li>{{ cause }}</li>
                            }
                        </ul>
                    </div>
                    <div class="info-section">
                        <h4>Pruebas Adjuntadas</h4>
                        @if (denounceDetails.proofs) {
                            @let proofs = denounceDetails.proofs.split(',');
                            <ul class="proof-list">
                                @for (proof of proofs; track proof) {
                                    @let proofName = proof.split('/')[2];
                                    @let extension = proofName.split('.')[1];
                                    <li class="proof-item" (click)="requestProof(proof)">
                                        @switch (extension) {
                                            @case ('pdf') {
                                                <i class="bi bi-file-pdf-fill"></i>
                                            }
                                            @case ('mp4') {
                                                <i class="bi bi-camera-video-fill"></i>
                                            }
                                            @default {
                                                <i class="bi bi-image-fill"></i>
                                            }
                                        }
                                        <p class="filename">{{ proofName }}</p>
                                    </li>
                                }
                            </ul>
                        } @else {
                            <div class="no-proofs">No hay pruebas disponibles</div>
                        }
                    </div>
                    <div class="info-section">
                        <h4>Descripción de las Pruebas</h4>
                        <p class="value">{{ denounceDetails.proofDescription.length === 0 ? 'No especifica' : denounceDetails.proofDescription }}</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <button (click)="closeDenounceDetailsModal()" class="close-modal-btn">Cerrar</button>
            <div>
                <button class="prev" [class.disabled-btn]="actualModalView === 0" (click)="backModalView()">Anterior</button>
                <button class="next" [class.disabled-btn]="actualModalView === 2" (click)="nextModalView()">Siguiente</button>
            </div>
        </div>
    </div>
</div> 

<!-- Modal de actualización de estado -->
<div class="modal update-denounce-modal" [ngClass]="{'closed': !showUpdateDenounceModal}">
    <div class="popup">
        <div class="head">
            <h3>Actualizar Estado de la Denuncia</h3>
        </div>
        <div class="content">
            <div class="info-section">
                <h4>
                    Estado Actual 
                    <span class="old-state">{{ updateDenounceModalInformation.oldState }}</span>
                </h4>
            </div>
            <div class="info-section">
                <h4>
                    Nuevo Estado 
                    <span class="new-state">{{ updateDenounceModalInformation.newState }}</span>
                </h4>
            </div>
            <div class="info-section">
                <h4>Descripción de Acciones Realizadas</h4>
                <textarea 
                    name="description-update-modal" 
                    id="description-update-modal" 
                    [(ngModel)]="updateDenounceModalInformation.description"
                    placeholder="Describa las acciones realizadas o los motivos del cambio de estado..."></textarea>
            </div>
        </div>
        <div class="footer">
            <button class="close-modal-btn" (click)="toggleShowUpdateDenounceModal()">Cancelar</button>
            <button class="update-btn" (click)="changeState()">Actualizar Estado</button>
        </div>
    </div>
</div> 

<!-- Modal de actualización de denunciado -->
<div class="modal update-denounced-modal" [ngClass]="{'closed': !showUpdateDenouncedModal}">
    <div class="popup">
        <div class="head">
            <h3>Actualizar Datos del Denunciado</h3>
        </div>
        <div class="content-denounced">
            @if (denouncedToUpdate) {
                <app-person-information-form 
                    [person]="denouncedToUpdate" 
                    [isDenounced]="true">
                </app-person-information-form>
            }
        </div>
        <div class="footer">
            <button class="close-modal-btn" (click)="closeUpdateDenouncedModal()">Cerrar</button>
            <button class="update-btn" (click)="updateDenouncedData()">Actualizar Denunciado</button>
        </div>
    </div>
</div>

<app-denounce-tracking-modal #trackingModal
    [consultant]="consultant"
    (stateUpdate)="processDenounceStateUpdate($event)">
</app-denounce-tracking-modal>
