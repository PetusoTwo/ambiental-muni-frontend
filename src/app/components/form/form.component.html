<main class="form-layout">
    <div class="global-container">
        <!-- Indicador de pasos uwu -->
        <div class="steps-indicator">
            <div class="step" [ngClass]="{'active': formActualStep === 0, 'completed': formActualStep > 0}">
                <div class="step-circle">
                    <i class="bi bi-person" *ngIf="formActualStep >= 0"></i>
                </div>
                <span class="step-label">Denunciante</span>
            </div>
            
            <div class="step-connector" [ngClass]="{'completed': formActualStep > 0}"></div>
            
            <div class="step" [ngClass]="{'active': formActualStep === 1, 'completed': formActualStep > 1}">
                <div class="step-circle">
                    <i class="bi bi-person" *ngIf="formActualStep >= 1"></i>
                </div>
                <span class="step-label">Denunciado</span>
            </div>
            
            <div class="step-connector" [ngClass]="{'completed': formActualStep > 1}"></div>
            
            <div class="step" [ngClass]="{'active': formActualStep === 2, 'completed': formActualStep > 2}">
                <div class="step-circle">
                    <i class="bi bi-clipboard" *ngIf="formActualStep >= 2"></i>
                </div>
                <span class="step-label">Detalles</span>
            </div>
            
            <div class="step-connector" [ngClass]="{'completed': formActualStep > 2}"></div>
            
            <div class="step" [ngClass]="{'active': formActualStep === 3, 'completed': formActualStep > 3}">
                <div class="step-circle">
                    <i class="bi bi-file-text" *ngIf="formActualStep >= 3"></i>
                </div>
                <span class="step-label">Resumen</span>
            </div>
        </div>

        <section [ngClass]="{ 'expand': formActualStep === 1, 'reduce': formActualStep === 4 }">
        
            @if(formActualStep === 4) {
        
                <ng-container *ngTemplateOutlet="formFinished"></ng-container>
        
            } @else {
        
                <ng-container *ngTemplateOutlet="formContent"></ng-container>
        
            }
        
        </section>
    </div>
</main>

<!-- Modal de error -->
<div class="error-popup-bg" [ngClass]="{'closed': !openModal}">
    <div class="error-popup">
        <div class="head">
            <h3>Alerta de campo de formulario</h3>
        </div>
        <hr>
        <div class="content">
            <p>{{ modalErrorMsg }}</p>
        </div>
        <hr>
        <div class="footer">
            <button (click)="toggleModal()" id="close-error-popup-btn">Cerrar</button>
        </div>
    </div>
</div>

<!-- Modal para conocer datos del denunciado -->
<div class="denounced-question-modal-bg" [ngClass]="{'closed': !showDenouncedQuestionModal}">
    <div class="denounced-question-modal">
        <div class="modal-head">
            <div class="icon-container">
                <i class="bi bi-question-circle"></i>
            </div>
            <h3>Información del Denunciado</h3>
        </div>
        
        <div class="modal-content">
            <p>¿Conoce los datos completos de la persona o entidad que desea denunciar?</p>
            <div class="info-text">
                <small>Si conoce los datos, podrá proporcionar información detallada del denunciado. Si no los conoce, puede continuar con su denuncia sin estos datos.</small>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn-modal btn-no" (click)="handleDenouncedDataQuestion(false)">
                <i class="bi bi-x-circle"></i>
                No conozco los datos
            </button>
            <button class="btn-modal btn-yes" (click)="handleDenouncedDataQuestion(true)">
                <i class="bi bi-check-circle"></i>
                Sí, conozco los datos
            </button>
        </div>
    </div>
</div>

<ng-template #formFinished>
    <article id="form-finished">
        <div class="form-content form-finished-content">
            
            @if (!formSended) {
                <div class="sending-state" role="status" aria-live="polite">
                    <div class="sending-body">
                        <div class="sending-icon">
                            <div class="lds-ring" aria-hidden="true"><div></div><div></div><div></div><div></div></div>
                        </div>
                        <div class="sending-text">
                            <h2>Enviando formulario</h2>
                            <p>Estamos procesando su denuncia. Esto puede tardar unos segundos, por favor no cierre la ventana.</p>
                        </div>
                    </div>
                </div>
            } @else {
                <div class="result-state">
                    <div class="result-body">
                        <div class="check-container">
                            <i class="bi bi-check"></i>
                        </div>
                        <h2>Formulario enviado correctamente</h2>
                        <p>
                            Para hacer seguimiento de su denuncia, le hemos enviado una notificación a: <strong>{{ denounce.denouncer.email }}</strong>.
                            Si no encuentra el correo revise su carpeta de spam o correo no deseado.
                        </p>
                        <button type="button" id="newDenounceBtn" (click)="goToNewDenounce()">
                            Realizar una nueva denuncia
                        </button>
                    </div>
                </div>
            }

        </div>
    </article>
</ng-template>

<ng-template #formContent>
    <article>

        <div class="form-content">
            @switch (formActualStep) {
                @case (0) {
                    <app-general-aspects [denounce]="denounce"></app-general-aspects>
                }
                @case (1) {
                    <app-denounced-aspects [denounce]="denounce"></app-denounced-aspects>
                }
                @case (2) {
                    <app-ambiental-denounce-form [denounce]="denounce"></app-ambiental-denounce-form>
                }
                @case (3) {
                    <app-proofs-form [proof]="denounce.proof" (proofUploadErrorEmitter)="processProofUploadError($event)"></app-proofs-form>
                }
            }
        </div>

    </article>
    <footer>
        <button class="btn" [ngClass]="{ 'desactivated': formActualStep === 0 }" id="back-btn" (click)="backStep()">Retroceder</button>
        <button class="btn" [ngClass]="{ 'send': formActualStep === 3 }" id="next-btn" (click)="changeStep()">{{ formActualStep === 3 ? "Enviar Denuncia": "Continuar" }}</button>
    </footer>
</ng-template>